# Packaging Stage
# This Dockerfile assumes binaries are built on the host and located in
# artifacts/shim/containerd-shim-rune-v2
# artifacts/agent/enclave-agent
# artifacts/config.json
# artifacts/shim-rune-config.toml

# Stage 1: Create Bundle
FROM alpine:latest AS bundle-builder
WORKDIR /payload

# Create rootfs for the "enclave"
RUN mkdir -p rootfs/bin rootfs/run/rune

# COPY agent from host context
COPY artifacts/agent/enclave-agent rootfs/bin/

# Pack unified-instance.tar
RUN tar -cf unified-instance.tar -C rootfs .

# Final Stage: The Payload Image
FROM alpine:latest
RUN apk add --no-cache bash
WORKDIR /opt/enclave-cc-artifacts

# COPY shim from host context
COPY artifacts/shim/containerd-shim-rune-v2 .
# COPY bundle from previous stage
COPY --from=bundle-builder /payload/unified-instance.tar .

# Copy scripts
COPY deps/enclave-cc/tools/packaging/deploy/enclave-cc-deploy.sh ./scripts/
COPY deps/enclave-cc/tools/packaging/build/runtimeclass/enclave-cc.yaml ./runtimeclass/

# Create mount points for host bind mounts (required for path mirroring)
RUN mkdir -p /run/containerd && \
    mkdir -p /var/lib/containerd

# Copy generated configuration files from artifacts/
COPY artifacts/config.json .
COPY artifacts/shim-rune-config.toml .

# Make script executable
RUN chmod +x /opt/enclave-cc-artifacts/scripts/enclave-cc-deploy.sh
